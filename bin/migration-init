#!/usr/bin/env python2.7

import migrations, subprocess

MIGRATION_SCHEMA = {
    'UP' : """
CREATE SCHEMA "migrations";

CREATE TABLE "migrations"."history" (
    "migration_id" serial PRIMARY KEY,
    "next_migration_id" int DEFAULT NULL,
    "hash" varchar(40) NOT NULL UNIQUE,
    "applied" boolean DEFAULT false,
    FOREIGN KEY ( "next_migration_id" ) REFERENCES
        "migrations"."history" ( "migration_id" )
);

CREATE INDEX "history_migration_id_idx" ON "migrations"."history" ( "migration_id" DESC );

CREATE INDEX "history_next_migration_id_idx" ON "migrations"."history" ( "next_migration_id" DESC NULLS FIRST );

CREATE INDEX "history_applied_idx" ON "migrations"."history" ( "applied" );
""",
    'DOWN' : 'DROP SCHEMA "migrations" CASCADE;'
}

class MigrationInit(migrations.Command):
    def main ( self, arguments=(), uninstall=False, **kwargs ):
        command = ('psql',) + arguments + ('-c',) + ('BEGIN TRANSACTION;\n%s\nCOMMIT TRANSACTION;' % (
                MIGRATION_SCHEMA['DOWN'] if uninstall else MIGRATION_SCHEMA['UP']
        ),)

        subprocess.call(command)


if __name__ == '__main__':
    command = MigrationInit(
    ).add_argument('--uninstall', action='store_true', help='uninstall the migrations schema instead'
    ).add_argument('ARGUMENTS', nargs='*', help='additional arguments to pass to the "psql" command, i.e. DBUSER, DBNAME, etc.'
    )

    command()

# vim: filetype=python
